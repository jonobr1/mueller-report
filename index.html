<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>The Mueller Report</title>
    <link rel="stylesheet" type="text/css" href="./styles/main.css">
  </head>
  <body>
    <div class="scripts">
      <script src="./node_modules/mpe/lib/mpe.js"></script>
      <script src="./third-party/three.js"></script>
      <script src="./third-party/two.js"></script>
      <script src="./src/page-reader.js"></script>
      <script src="./src/controller.js"></script>
      <script src="./src/sequencer.js"></script>
      <script src="./src/fonts.js"></script>
      <script>

        var dimensions = 100;
        var data, palette = {
          isPositive: true,
          background: new THREE.Color(0x000000),
          foreground: new THREE.Color(0xffffff)
        };

        var fonts = new Fonts([
          {
            value: 'Knockout HTF66-FullFlyweight',
            url: './assets/fonts/Knockout-HTF66-FullFlyweight.otf'
          },
          {
            value: 'Knockout HTF67-FullBantamweight',
            url: './assets/fonts/Knockout-HTF67-FullBantamwt.otf'
          },
          {
            value: 'Knockout HTF68-FullFeatherweight',
            url: './assets/fonts/Knockout-HTF68-FullFeatherwt.otf'
          },
          {
            value: 'Knockout HTF69-FullLiteweight',
            url: './assets/fonts/Knockout-HTF69-FullLiteweight.otf'
          },
          {
            value: 'Knockout HTF70-FullWelterweight',
            url: './assets/fonts/Knockout-HTF70-FullWelterwt.otf'
          },
          {
            value: 'Knockout HTF71-FullMiddleweight',
            url: './assets/fonts/Knockout-HTF71-FullMiddlewt.otf'
          },
          {
            value: 'Knockout HTF72-FullCruiserweight',
            url: './assets/fonts/Knockout-HTF72-FullCruiserwt.otf'
          },
          {
            value: 'Knockout HTF73-FullHeviweight',
            url: './assets/fonts/Knockout-HTF73-FullHeviweight.otf'
          },
          {
            value: 'Knockout HTF74-FullSumo',
            url: './assets/fonts/Knockout-HTF74-FullSumo.otf'
          }
        ]);

        var renderer = new THREE.WebGLRenderer({ antialias: true });
        var scene = new THREE.Scene();
        var camera = new THREE.PerspectiveCamera(75);

        renderer.setPixelRatio(2);
        Two.Text.Ratio = 1;

        var two = new Two({
          type: Two.Types.canvas,
          width: 512,
          height: 512,
          ratio: 2,
          autostart: true
        });

        var text = two.makeText('', 0, 0, {
          fill: 'white',
          stroke: 'transparent',
          family: '"Knockout HTF26-JuniorFlyweight", sans-serif'
        });

        var plane = new THREE.Mesh(
          new THREE.PlaneBufferGeometry(dimensions, dimensions, 128, 128),
          new THREE.MeshBasicMaterial({
            color: palette.foreground,
            transparent: true,
            map: new THREE.Texture(two.renderer.domElement)
          })
        );

        plane.userData.active = false;

        var controller = new Controller();

        var reader = new PageReader('./assets/mueller-report.json');
        reader.bind('load', setup);

        var sequencer = new Sequencer();

        function setup() {

          camera.position.z = dimensions;

          scene.add(plane);

          renderer.setClearColor(palette.background);
          document.body.appendChild(renderer.domElement);

          two.scene.position.set(two.width / 2, two.height / 2);

          nextPage();

          controller.bind('down', onControllerDown)
            .bind('update', onControllerUpdate)
            .bind('up', onControllerUp)
            .bind('blur', onControllerBlur);

          sequencer.bind('down', onSequenceDown)
            .bind('up', onSequenceUp);

          two.bind('update', update);
          window.addEventListener('resize', resize, false);
          resize();

        }

        function resize() {

          var width = window.innerWidth;
          var height = window.innerHeight;

          renderer.setSize(width, height);
          camera.aspect = width / height;
          camera.updateProjectionMatrix()

        }

        function update() {

          sequencer.update();

          if (!plane.userData.active) {
            plane.material.opacity -= plane.material.opacity * 0.1;
          }

          var cp = controller.pressure;
          var pressure = Math.pow(cp, 5);

          if (pressure > 0) {
            var x = pressure * (Math.random() - 0.5);
            var y = pressure * (Math.random() - 0.5);
            plane.position.set(x, y, 0);
          } else if (plane.position.x !== 0
            || plane.position.y !== 0 || plane.position.z !== 0) {
            plane.position.set(0, 0, 0);
          }

          renderer.render(scene, camera);

        }

        function onControllerDown(e) {

          if (sequencer.getRecording() && sequencer.getCurrent()) {
            sequencer.getCurrent().add('down', e);
          }

          switch (e.noteNumber) {

            // "Black Keys"
            case 1:
              sequencer.setRecording(true);
              break;
            case 3:
              sequencer.clear();
              break;
            case 6:
            case 8:
            case 10:
            case 13:
            case 15:
            case 18:
            case 20:
              break;
            case 22:
              palette.background.set(0xffffff);
              palette.foreground.set(0x000000);
              renderer.setClearColor(palette.background);
              plane.material.color = palette.foreground;
              break;
            default:
              // "White Keys"
              updateText(e);
          }

        }

        function onSequenceDown(e) {

          switch (e.noteNumber) {

            // "Black Keys"
            case 1:
            case 3:
            case 6:
            case 8:
            case 10:
            case 13:
            case 15:
            case 18:
            case 20:
              break;
            case 22:
              palette.background.set(0xffffff);
              palette.foreground.set(0x000000);
              renderer.setClearColor(palette.background);
              plane.material.color = palette.foreground;
              break;
            default:
              // "White Keys"
              updateText(e);
          }

        }

        function onControllerUpdate(e) {

          switch (e.noteNumber) {
            case 20:
              var zoom = (e.timbre - 0.5) / (0.7 - 0.5);
              if (zoom < 0) {
                zoom = 0;
              } else if (zoom > 1) {
                zoom = 1;
              }
              var fov = (1 - zoom) * 45 + 30;
              camera.fov += (fov - camera.fov) * 0.33;
              camera.updateProjectionMatrix();
              break;
          }

        }

        function onControllerUp(e) {

          switch (e.noteNumber) {
            case 1:
              sequencer.setRecording(false);
              break;
            case 22:
              palette.background.set(0x000000);
              palette.foreground.set(0xffffff);
              renderer.setClearColor(palette.background);
              plane.material.color = palette.foreground;
            default:
              if (sequencer.getRecording() && sequencer.getCurrent()) {
                sequencer.getCurrent().add('up', e);
              }
          }

        }

        function onSequenceUp(e) {

          switch (e.noteNumber) {
            case 22:
              palette.background.set(0x000000);
              palette.foreground.set(0xffffff);
              renderer.setClearColor(palette.background);
              plane.material.color = palette.foreground;
              break;
          }

        }

        function onControllerBlur() {

          plane.userData.active = false;

        }

        function updateText(e) {

          var index = data.index;
          text.value = data[index].toUpperCase();
          text.scale = 1;

          var rect = text.getBoundingClientRect(true);
          text.scale = Math.min(two.height / rect.height, two.width / rect.width, 10);

          var pct = e.noteNumber / 24;
          var index = Math.floor(fonts.families.length * pct);
          text.family = fonts.families[index].family;

          plane.material.map.needsUpdate = true;
          plane.material.opacity = 1;
          plane.userData.active = true;

          data.index++;
          if (data.index >= data.length) {
            nextPage();
          }

        }

        function nextPage() {
          data = reader.next();
          data.index = 0;
        }

      </script>
    </div>
  </body>
</html>
